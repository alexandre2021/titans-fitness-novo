# üèãÔ∏è Sistema de Execu√ß√£o de Rotinas

Este documento descreve a arquitetura e o fluxo de funcionamento do sistema de execu√ß√£o de rotinas, que √© compartilhado entre Personal Trainers e Alunos.

## üìÇ Estrutura de Arquivos Essencial

```
src/
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ PaginaRotinas.tsx               # ‚úÖ Hub central para ver/gerenciar rotinas (PT e Aluno)
‚îÇ   ‚îú‚îÄ‚îÄ ExecucaoSelecionarTreino.tsx    # 1¬™ etapa: Sele√ß√£o de treino/sess√£o
‚îÇ   ‚îî‚îÄ‚îÄ ExecucaoExecutarTreino.tsx      # 2¬™ etapa: Coordenador da execu√ß√£o
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ProtectedRoutes.tsx         # Define o layout (PT ou Aluno)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AlunoBottomNav.tsx          # Navega√ß√£o mobile do aluno
‚îÇ   ‚îî‚îÄ‚îÄ rotina/
‚îÇ       ‚îú‚îÄ‚îÄ RotinaDetalhesModal.tsx     # Modal de detalhes para o aluno
‚îÇ       ‚îî‚îÄ‚îÄ execucao/
‚îÇ           ‚îú‚îÄ‚îÄ Executor.tsx            # Interface unificada de execu√ß√£o
‚îÇ           ‚îî‚îÄ‚îÄ shared/                 # Componentes da tela de execu√ß√£o (mantidos)
‚îÇ               ‚îú‚îÄ‚îÄ RegistroSerieSimples.tsx
‚îÇ               ‚îú‚îÄ‚îÄ RegistroSerieCombinada.tsx
‚îÇ               ‚îú‚îÄ‚îÄ CronometroSerie.tsx
‚îÇ               ‚îú‚îÄ‚îÄ CronometroExercicio.tsx
‚îÇ               ‚îú‚îÄ‚îÄ ExercicioDetalhesModal.tsx
‚îÇ               ‚îî‚îÄ‚îÄ ExercicioHistoricoModal.tsx
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useExercicioExecucao.ts         # Hook principal com toda a l√≥gica
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ exercicio.types.ts              # Tipagens do sistema
```

---

## üîÑ Fluxo de Funcionamento

O fluxo de entrada √© diferente para cada perfil, mas converge para as mesmas telas de execu√ß√£o.

### 1. Fluxo de Entrada (Personal Trainer)

1.  PT navega para a lista de seus alunos e clica em "Ver Rotinas".
2.  √â direcionado para `/alunos-rotinas/:alunoId`.
3.  A rota renderiza `<PaginaRotinas modo="personal" />`, que exibe a lista de rotinas do aluno com op√ß√µes de gerenciamento.
4.  Ao clicar em "Treinar", navega para a tela de sele√ß√£o de treino.

### 2. Fluxo de Entrada (Aluno)

1.  Aluno clica em "Rotinas" no `AlunoBottomNav`.
2.  √â direcionado para `/minhas-rotinas`.
3.  A rota renderiza `<PaginaRotinas modo="aluno" />`, que exibe suas pr√≥prias rotinas com op√ß√µes limitadas.
4.  Ao clicar em "Executar Treino", navega para a tela de sele√ß√£o de treino.

### 3. Fluxo de Execu√ß√£o (Comum a ambos)

```mermaid
graph TD
    A[PaginaRotinas.tsx] -->|Navega com state: { modo }| B(ExecucaoSelecionarTreino.tsx);
    B --> C(ExecucaoExecutarTreino.tsx);
    C --> D{Finaliza√ß√£o};
    D --> E[Arquivamento Autom√°tico];
    E --> A;
```

---

## ‚öôÔ∏è Componentes e L√≥gica Principal

**PaginaRotinas.tsx:**
-   **Ponto de Entrada Principal.** Renderiza a lista de rotinas.
-   A prop `modo` adapta a UI e as a√ß√µes dispon√≠veis (criar/editar vs. apenas executar).
-   √â a origem da navega√ß√£o para a execu√ß√£o de treinos para ambos os perfis.

**ProtectedRoutes.tsx:**
-   Atua como um "roteador de layout".
-   Verifica o `user_type` e renderiza o layout correto (`AlunoLayout` ou `PTLayout`).
-   Garante que as p√°ginas de execu√ß√£o compartilhadas sejam exibidas com a interface correta para cada usu√°rio.

**useExercicioExecucao.ts (Hook Principal):**
-   Recebe o `modo` ('pt' ou 'aluno') como argumento.
-   Carrega os exerc√≠cios e o progresso salvo da sess√£o.
-   Gerencia o cron√¥metro geral da sess√£o.
-   Valida o acesso √† rotina (status 'Ativa', permiss√£o do aluno).
-   Cont√©m as fun√ß√µes `pausarSessao` e `salvarExecucaoCompleta`.
-   **Novo:** Gerencia o processo completo de arquivamento autom√°tico quando a rotina √© finalizada.

**Executor.tsx:**
-   A interface de execu√ß√£o em si.
-   Renderiza a lista de exerc√≠cios, os cron√¥metros e os modais de registro.
-   √â um componente "burro" que recebe a l√≥gica do hook `useExercicioExecucao`.
-   **Atualizado:** Comportamento de finaliza√ß√£o id√™ntico para PT e Aluno (sem modais de verifica√ß√£o de completude).

### Componentes da Interface de Execu√ß√£o (`/shared/`)

Estes componentes s√£o os blocos de constru√ß√£o da tela do `Executor.tsx` e s√£o essenciais para a interatividade do usu√°rio durante o treino. Eles foram mantidos da arquitetura original e continuam com suas funcionalidades principais.

#### Componentes de Registro de S√©ries

-   **`RegistroSerieSimples.tsx` & `RegistroSerieCombinada.tsx`**:
    -   **Fun√ß√£o:** Interfaces para o usu√°rio registrar os dados de uma s√©rie. A vers√£o `Simples` √© para um exerc√≠cio normal, enquanto a `Combinada` √© para bi-sets/super-sets.
    -   **Campos:** Repeti√ß√µes executadas, carga utilizada, e um campo opcional para observa√ß√µes.
    -   **Comportamento:** Validam os dados e os enviam para o hook `useExercicioExecucao` para serem salvos no estado e, posteriormente, no banco de dados.

#### Componentes de Cron√¥metro

-   **`CronometroSerie.tsx`**:
    -   **Fun√ß√£o:** Apresenta um modal com um timer regressivo para o descanso **entre as s√©ries** de um mesmo exerc√≠cio.
    -   **Trigger:** √â acionado automaticamente ap√≥s o usu√°rio salvar os dados de uma s√©rie.
    -   **Dura√ß√£o:** O tempo de descanso √© configurado na cria√ß√£o da rotina, com um valor padr√£o.

-   **`CronometroExercicio.tsx`**:
    -   **Fun√ß√£o:** Apresenta um modal com um timer regressivo para o descanso **entre exerc√≠cios diferentes**.
    -   **Trigger:** √â acionado automaticamente ap√≥s o usu√°rio completar a √∫ltima s√©rie de um exerc√≠cio.
    -   **Dura√ß√£o:** O tempo de descanso √© configurado na cria√ß√£o da rotina, com um valor padr√£o.

#### Modais de Informa√ß√£o

-   **`ExercicioDetalhesModal.tsx`**:
    -   **Fun√ß√£o:** Exibe um modal com todas as informa√ß√µes t√©cnicas de um exerc√≠cio.
    -   **Conte√∫do:** M√∫sculos prim√°rios/secund√°rios, instru√ß√µes de execu√ß√£o, dicas de seguran√ßa e as m√≠dias (imagens/v√≠deos) associadas.
    -   **Acesso:** Dispon√≠vel atrav√©s de um √≠cone de "informa√ß√£o" no card do exerc√≠cio durante a execu√ß√£o.

-   **`ExercicioHistoricoModal.tsx`**:
    -   **Fun√ß√£o:** Exibe um modal com o hist√≥rico de execu√ß√µes anteriores para um exerc√≠cio espec√≠fico.
    -   **Conte√∫do:** Mostra um gr√°fico ou uma tabela com a progress√£o de cargas e repeti√ß√µes ao longo do tempo, ajudando o usu√°rio a visualizar sua evolu√ß√£o.
    -   **Acesso:** Dispon√≠vel atrav√©s de um √≠cone de "hist√≥rico" no card do exerc√≠cio.

---

## üéØ Modos de Execu√ß√£o (PT vs. Aluno) - ATUALIZADO

A interface de execu√ß√£o √© a mesma e o comportamento de finaliza√ß√£o √© id√™ntico para ambos os perfis:

| Caracter√≠stica | Modo Personal Trainer | Modo Aluno |
|---|---|---|
| **Acesso** | Acesso total a qualquer rotina de seus alunos. | Acesso apenas √†s suas pr√≥prias rotinas e se `permite_execucao_aluno = true`. |
| **Finaliza√ß√£o** | **Pode finalizar a qualquer momento, sem valida√ß√µes de completude.** | **Pode finalizar a qualquer momento, sem valida√ß√µes de completude.** |
| **Interface** | O cabe√ßalho mostra o nome do aluno que est√° treinando. | O cabe√ßalho mostra uma sauda√ß√£o pessoal. |
| **Navega√ß√£o** | Ao finalizar, retorna para a p√°gina de rotinas do aluno (`/alunos-rotinas/:id`). | Ao finalizar, retorna para a sua √°rea de rotinas (`/minhas-rotinas`). |
| **Arquivamento** | Executa o processo completo de arquivamento quando finaliza a √∫ltima sess√£o de uma rotina. | Executa o processo completo de arquivamento quando finaliza a √∫ltima sess√£o de uma rotina. |

### Mudan√ßas Importantes:
- **Removido:** Modal de verifica√ß√£o de completude para alunos
- **Unificado:** Comportamento de finaliza√ß√£o id√™ntico entre PT e Aluno
- **Mantido:** Valida√ß√µes de acesso e interface diferenciada por perfil

---

## üí° Diferencia√ß√£o de Comportamentos

### Modal vs. P√°gina de Detalhes

**Aluno:**
-   Clica em "Detalhes" ‚Üí Abre `RotinaDetalhesModal.tsx` sobre a p√°gina atual.
-   Visualiza√ß√£o r√°pida dos treinos e exerc√≠cios sem sair da p√°gina principal.

**Personal Trainer:**
-   Clica em "Detalhes" ‚Üí Navega para p√°gina completa de gerenciamento.
-   Acesso completo: `/alunos-rotinas/:alunoId/:rotinaId`.

---

## üóÇÔ∏è Persist√™ncia e Arquivamento - ATUALIZADO

### Processo de Execu√ß√£o e Salvamento

O processo de salvar o progresso, pausar e finalizar permanece o mesmo e √© gerenciado pelo `useExercicioExecucao`, que √© acionado a partir do `Executor.tsx`.

### Arquivamento Autom√°tico Completo

**Quando a √∫ltima sess√£o de uma rotina √© finalizada, o sistema automaticamente:**

1. **Atualiza Status:** Rotina passa de "Ativa" para "Conclu√≠da"
2. **Verifica Completude:** Confirma que todas as sess√µes da rotina est√£o finalizadas
3. **Inicia Arquivamento Autom√°tico:**
   - Busca dados completos da rotina (exerc√≠cios, s√©ries, execu√ß√µes)
   - **L√≥gica FIFO:** Verifica rotinas arquivadas do aluno (limite 4)
   - **Limpeza:** Remove rotinas antigas (PDFs do Cloudflare + registros do banco)
   - **Gera√ß√£o PDF:** Chama edge function `gerar-pdf-conclusao`
   - **Upload:** Envia PDF para Cloudflare R2 via `upload-media`
   - **Arquivamento:** Salva metadados em `rotinas_arquivadas`
   - **Exclus√£o:** Remove rotina e dados relacionados da base ativa (CASCADE)

### Sistema FIFO de Rotinas Arquivadas

- **Limite:** M√°ximo 4 rotinas arquivadas por aluno
- **Crit√©rio:** Ordem cronol√≥gica (First In, First Out)
- **Limpeza:** Automaticamente remove rotinas mais antigas ao ultrapassar o limite
- **Recursos:** Deleta PDFs do Cloudflare e registros do banco simultaneamente

---

## üîí Pol√≠ticas de Seguran√ßa (RLS) - NOVO

### Tabela `rotinas` - Pol√≠ticas Row Level Security

**Personal Trainer:**
```sql
-- Pol√≠tica: "Allow authenticated PTs to manage their routines"
-- Comando: ALL (CREATE, READ, UPDATE, DELETE)
-- Condi√ß√£o: auth.uid() = personal_trainer_id
```

**Aluno:**
```sql
-- Pol√≠tica: "Allow authenticated students to view their routines"  
-- Comando: SELECT
-- Condi√ß√£o: auth.uid() = aluno_id

-- Pol√≠tica: "Allow students to update their completed routines"
-- Comando: UPDATE  
-- Condi√ß√£o: auth.uid() = aluno_id AND status = 'Ativa'
-- Verifica√ß√£o: auth.uid() = aluno_id AND status = 'Conclu√≠da'

-- Pol√≠tica: "Allow students to delete their completed routines"
-- Comando: DELETE
-- Condi√ß√£o: auth.uid() = aluno_id AND status = 'Conclu√≠da'
```

### Cascata de Exclus√£o

As seguintes foreign keys possuem `ON DELETE CASCADE`:
- `treinos.rotina_id` ‚Üí `rotinas.id`
- `execucoes_sessao.rotina_id` ‚Üí `rotinas.id`

Isso garante que ao excluir uma rotina, todos os dados relacionados s√£o automaticamente removidos.

---

## üêõ Sistema de Debug

O sistema possui logs extensivos para troubleshooting em desenvolvimento:

```typescript
// Exemplos de logs no console:
üöÄ Entrando na execu√ß√£o - Resetando estados locais
üî• DEBUG - EXERC√çCIOS ATUALIZADOS: Array(1)
üíæ Finalizando sess√£o definitivamente - Modo: aluno
üéâ Rotina completa detectada! Iniciando processo completo...
üóÑÔ∏è Iniciando processo de arquivamento da rotina...
üìÑ Gerando PDF de conclus√£o...
‚òÅÔ∏è Fazendo upload do PDF para Cloudflare...
üóëÔ∏è Removendo rotina da base ativa...
üéâ Processo de arquivamento conclu√≠do com sucesso!
```

Estes logs permitem acompanhar todo o fluxo de execu√ß√£o e identificar rapidamente onde podem ocorrer falhas.

---

## üîß Configura√ß√£o Necess√°ria

### Rotas (App.tsx)

```typescript
// O componente ProtectedRoutes √© o respons√°vel por decidir o layout.
import ProtectedRoutes from "./components/layout/ProtectedRoutes";

<Routes>
  {/* Rotas P√∫blicas */}
  <Route path="/login" element={<Login />} />
  
  {/* ROTAS PROTEGIDAS (PT e Aluno) */}
  <Route element={<AuthGuard><ProtectedRoutes /></AuthGuard>}>
    {/* 
      O ProtectedRoutes renderiza o layout correto (PT ou Aluno) 
      e o <Outlet /> dentro do layout renderiza a rota filha.
    */}
    
    {/* Rota do PT para ver as rotinas de um aluno espec√≠fico */}
    <Route 
      path="/alunos-rotinas/:alunoId" 
      element={<PaginaRotinas modo="personal" />} 
    />
    
    {/* Rota do Aluno para ver suas pr√≥prias rotinas */}
    <Route 
      path="/minhas-rotinas" 
      element={<PaginaRotinas modo="aluno" />} 
    />
    
    {/* Rotas de Execu√ß√£o (Compartilhadas e renderizadas no layout correto) */}
    <Route 
      path="/execucao-rotina/selecionar-treino/:rotinaId" 
      element={<ExecucaoSelecionarTreino />} 
    />
    <Route 
      path="/execucao-rotina/executar-treino/:sessaoId" 
      element={<ExecucaoExecutarTreino />} 
    />
  </Route>
</Routes>
```

### Navega√ß√£o

```typescript
// A partir da PaginaRotinas.tsx
navigate(
  `/execucao-rotina/selecionar-treino/${rotinaId}`, 
  { state: { modo: 'pt' } } // ou 'aluno'
);
```

---

## üöÄ Melhorias Implementadas

### Arquiteturais
- Centraliza√ß√£o da l√≥gica de rotinas em um √∫nico componente inteligente
- Elimina√ß√£o de duplica√ß√£o de c√≥digo entre PT e Aluno
- Fluxo de navega√ß√£o mais consistente e previs√≠vel
- Unifica√ß√£o do comportamento de finaliza√ß√£o

### Funcionais
- **Arquivamento autom√°tico completo:** PDF, upload, limpeza, exclus√£o
- **Sistema FIFO robusto:** Mant√©m hist√≥rico organizado por aluno
- **Pol√≠ticas RLS granulares:** Seguran√ßa adequada para cada perfil
- **Logs de debug extensivos:** Facilita troubleshooting e manuten√ß√£o

### Experi√™ncia do Usu√°rio
- **Processo transparente:** Usu√°rio n√£o precisa se preocupar com arquivamento
- **Comportamento consistente:** PT e Aluno t√™m mesma experi√™ncia de finaliza√ß√£o
- **Performance otimizada:** Processo em background n√£o trava a interface

---

*Vers√£o: 4.0 | Status: Documento completamente atualizado e alinhado com implementa√ß√£o atual*